
<!DOCTYPE html>
<html lang="ku" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Madphone - Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Noto Sans Arabic', sans-serif; background-color: #f9fafb; }
        .modal { display: none; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); }
        .modal.active { display: flex; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #8b5cf6; border-radius: 10px; }
    </style>
</head>
<body class="text-gray-900">
    <!-- Nav -->
    <nav class="bg-white shadow-lg sticky top-0 z-50 border-b-2 border-purple-100">
        <div class="max-w-7xl mx-auto px-4 h-16 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <i data-lucide="shield" class="text-purple-600 w-8 h-8"></i>
                <h1 class="text-2xl font-bold text-purple-900">Madphone Admin</h1>
            </div>
            <span class="bg-purple-50 text-purple-600 px-4 py-1 rounded-full text-sm font-bold border border-purple-100">سەرپەرشتیار</span>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 mt-8 space-y-10 pb-20">
        <!-- Stats -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
            <div class="bg-white p-6 rounded-2xl shadow-sm border flex items-center gap-4">
                <div class="p-4 rounded-xl bg-indigo-50 text-indigo-600"><i data-lucide="package"></i></div>
                <div><p class="text-gray-400 text-sm">بەرهەم</p><h4 id="statProducts" class="text-2xl font-bold">0</h4></div>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border flex items-center gap-4">
                <div class="p-4 rounded-xl bg-blue-50 text-blue-600"><i data-lucide="shopping-cart"></i></div>
                <div><p class="text-gray-400 text-sm">داواکاری</p><h4 id="statOrders" class="text-2xl font-bold">0</h4></div>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border flex items-center gap-4">
                <div class="p-4 rounded-xl bg-amber-50 text-amber-600"><i data-lucide="clock"></i></div>
                <div><p class="text-gray-400 text-sm">چاوەڕوان</p><h4 id="statPending" class="text-2xl font-bold">0</h4></div>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border flex items-center gap-4">
                <div class="p-4 rounded-xl bg-emerald-50 text-emerald-600"><i data-lucide="dollar-sign"></i></div>
                <div><p class="text-gray-400 text-sm">داهات</p><h4 id="statRevenue" class="text-2xl font-bold">$0</h4></div>
            </div>
        </div>

        <!-- Products Table -->
        <section class="bg-white rounded-2xl shadow-sm border overflow-hidden">
            <div class="p-6 border-b flex justify-between items-center bg-gray-50/50">
                <h3 class="text-xl font-bold flex items-center gap-2"><i data-lucide="package" class="text-purple-600"></i> لیستەی بەرهەمەکان</h3>
                <button onclick="toggleModal('productModal', true)" class="bg-purple-600 text-white px-5 py-2 rounded-xl font-bold hover:bg-purple-700 transition-colors flex items-center gap-2 shadow-lg shadow-purple-100">
                    <i data-lucide="plus" class="w-4 h-4"></i> زیادکردنی بەرهەم
                </button>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-right">
                    <thead class="bg-gray-50 text-gray-500 text-sm font-bold border-b">
                        <tr>
                            <th class="p-4">بەرهەم</th>
                            <th class="p-4">نرخ</th>
                            <th class="p-4">بڕی کۆگا</th>
                            <th class="p-4">فرۆشراو</th>
                            <th class="p-4">کردارەکان</th>
                        </tr>
                    </thead>
                    <tbody id="productTableBody" class="divide-y">
                        <!-- Products injected here -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Orders Section -->
        <section class="space-y-6">
            <h3 class="text-xl font-bold flex items-center gap-2"><i data-lucide="shopping-cart" class="text-blue-600"></i> داواکارییەکان</h3>
            <div id="ordersGrid" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Orders injected here -->
            </div>
        </section>
    </main>

    <!-- Product Modal -->
    <div id="productModal" class="modal fixed inset-0 z-50 items-center justify-center p-4">
        <div class="bg-white rounded-3xl w-full max-w-lg shadow-2xl p-8 space-y-4">
            <h3 id="modalTitle" class="text-2xl font-bold">زیادکردنی بەرهەم</h3>
            <input id="prodName" class="w-full p-3 border rounded-xl" placeholder="ناوی بەرهەم">
            <div class="grid grid-cols-2 gap-4">
                <input id="prodPrice" type="number" class="w-full p-3 border rounded-xl" placeholder="نرخ $">
                <input id="prodQty" type="number" class="w-full p-3 border rounded-xl" placeholder="بڕی کۆگا">
            </div>
            <textarea id="prodDesc" class="w-full p-3 border rounded-xl h-24" placeholder="وەسفی کورت"></textarea>
            <input id="prodImg" class="w-full p-3 border rounded-xl" placeholder="لینکی وێنە (URL)">
            <button onclick="saveProduct()" class="w-full bg-purple-600 text-white py-4 rounded-2xl font-bold shadow-xl">پاشەکەوتکردن</button>
            <button onclick="closeProductModal()" class="w-full text-gray-400">داخستن</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, onValue } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAx6nZbWvHGkk0zRQdIVHbG2hmK29pWzAY",
            authDomain: "madphone-1706c.firebaseapp.com",
            databaseURL: "https://madphone-1706c-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "madphone-1706c",
            storageBucket: "madphone-1706c.firebasestorage.app",
            messagingSenderId: "777789640049",
            appId: "1:777789640049:web:71255405df7ffc32257ad0"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const dbRef = ref(db, '/');

        let storeData = { products: [], orders: [], nextOrderId: 1, nextProductId: 1 };
        let editingId = null;

        window.toggleModal = (id, show) => {
            document.getElementById(id).classList.toggle('active', show);
        };

        onValue(dbRef, (snapshot) => {
            if (snapshot.exists()) {
                const data = snapshot.val();
                storeData = {
                    products: data.products ? (Array.isArray(data.products) ? data.products : Object.values(data.products)) : [],
                    orders: data.orders ? (Array.isArray(data.orders) ? data.orders : Object.values(data.orders)) : [],
                    nextOrderId: data.nextOrderId || 1,
                    nextProductId: data.nextProductId || 1
                };
                updateDashboard();
            }
        });

        function updateDashboard() {
            document.getElementById('statProducts').textContent = storeData.products.length;
            document.getElementById('statOrders').textContent = storeData.orders.length;
            document.getElementById('statPending').textContent = storeData.orders.filter(o => o.status === 'pending').length;
            const rev = storeData.orders.filter(o => o.status === 'completed').reduce((s, o) => s + o.total, 0);
            document.getElementById('statRevenue').textContent = `$${rev.toFixed(2)}`;

            renderProducts();
            renderOrders();
        }

        function renderProducts() {
            const tbody = document.getElementById('productTableBody');
            tbody.innerHTML = storeData.products.map(p => `
                <tr class="hover:bg-gray-50 transition-colors">
                    <td class="p-4 font-bold">${p.name}</td>
                    <td class="p-4 text-purple-600 font-bold">$${p.price}</td>
                    <td class="p-4">${p.quantity}</td>
                    <td class="p-4 text-green-600 font-bold">${p.sold || 0}</td>
                    <td class="p-4">
                        <div class="flex gap-2">
                            <button onclick="editProduct(${p.id})" class="text-blue-500 p-2 hover:bg-blue-50 rounded-lg"><i data-lucide="edit"></i></button>
                            <button onclick="deleteProduct(${p.id})" class="text-red-500 p-2 hover:bg-red-50 rounded-lg"><i data-lucide="trash-2"></i></button>
                        </div>
                    </td>
                </tr>
            `).join('');
            lucide.createIcons();
        }

        function renderOrders() {
            const grid = document.getElementById('ordersGrid');
            grid.innerHTML = storeData.orders.slice().reverse().map(order => `
                <div class="bg-white p-6 rounded-2xl border-2 ${order.status === 'pending' ? 'border-amber-100 bg-amber-50/10' : 'border-gray-100'} shadow-sm">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h4 class="font-bold text-lg">#${order.id} - ${order.customerName}</h4>
                            <p class="text-sm text-gray-500">${order.phone} | ${order.location}</p>
                        </div>
                        <span class="px-3 py-1 rounded-full text-xs font-bold ${order.status === 'pending' ? 'bg-amber-100 text-amber-700' : (order.status === 'completed' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700')}">${order.status}</span>
                    </div>
                    <div class="bg-white p-4 rounded-xl space-y-2 text-sm border">
                        ${order.items.map(i => `<div class="flex justify-between"><span>${i.name} x${i.quantity}</span><span class="font-bold">$${i.price * i.quantity}</span></div>`).join('')}
                        <div class="pt-2 border-t flex justify-between font-bold text-indigo-600"><span>کۆی گشتی</span><span>$${order.total}</span></div>
                    </div>
                    ${order.status === 'pending' ? `
                        <div class="mt-4 flex gap-3">
                            <button onclick="updateOrderStatus(${order.id}, 'completed')" class="flex-1 bg-green-500 text-white py-2 rounded-xl font-bold flex items-center justify-center gap-2"><i data-lucide="check"></i> تەواوکردن</button>
                            <button onclick="updateOrderStatus(${order.id}, 'cancelled')" class="flex-1 bg-red-500 text-white py-2 rounded-xl font-bold flex items-center justify-center gap-2"><i data-lucide="x"></i> هەڵوەشاندن</button>
                        </div>
                    ` : ''}
                </div>
            `).join('');
            lucide.createIcons();
        }

        window.saveProduct = async () => {
            const name = document.getElementById('prodName').value;
            const price = parseFloat(document.getElementById('prodPrice').value);
            const qty = parseInt(document.getElementById('prodQty').value);
            const desc = document.getElementById('prodDesc').value;
            const img = document.getElementById('prodImg').value;

            if(!name || isNaN(price)) return alert('ناوی بەرهەم و نرخ بنووسە');

            let updatedProducts;
            let nextPid = storeData.nextProductId;

            if(editingId) {
                updatedProducts = storeData.products.map(p => p.id === editingId ? { ...p, name, price, quantity: qty, description: desc, image: img } : p);
            } else {
                const newP = { id: nextPid, name, price, quantity: qty, sold: 0, pending: 0, description: desc, image: img };
                updatedProducts = [...storeData.products, newP];
                nextPid++;
            }

            await set(dbRef, { ...storeData, products: updatedProducts, nextProductId: nextPid });
            closeProductModal();
        };

        window.editProduct = (id) => {
            const p = storeData.products.find(item => item.id === id);
            editingId = id;
            document.getElementById('modalTitle').textContent = 'دەستکاریکردنی بەرهەم';
            document.getElementById('prodName').value = p.name;
            document.getElementById('prodPrice').value = p.price;
            document.getElementById('prodQty').value = p.quantity;
            document.getElementById('prodDesc').value = p.description || '';
            document.getElementById('prodImg').value = p.image || '';
            toggleModal('productModal', true);
        };

        window.closeProductModal = () => {
            editingId = null;
            document.getElementById('modalTitle').textContent = 'زیادکردنی بەرهەم';
            document.getElementById('prodName').value = '';
            document.getElementById('prodPrice').value = '';
            document.getElementById('prodQty').value = '';
            document.getElementById('prodDesc').value = '';
            document.getElementById('prodImg').value = '';
            toggleModal('productModal', false);
        };

        window.deleteProduct = async (id) => {
            if(!confirm('دڵنیای لە سڕینەوە؟')) return;
            const updated = storeData.products.filter(p => p.id !== id);
            await set(dbRef, { ...storeData, products: updated });
        };

        window.updateOrderStatus = async (oid, status) => {
            const order = storeData.orders.find(o => o.id === oid);
            const updatedOrders = storeData.orders.map(o => o.id === oid ? { ...o, status } : o);
            
            const updatedProducts = storeData.products.map(p => {
                const item = order.items.find(i => i.productId === p.id);
                if(item) {
                    if(status === 'completed') return { ...p, pending: p.pending - item.quantity, sold: (p.sold || 0) + item.quantity };
                    if(status === 'cancelled') return { ...p, pending: p.pending - item.quantity, quantity: p.quantity + item.quantity };
                }
                return p;
            });

            await set(dbRef, { ...storeData, orders: updatedOrders, products: updatedProducts });
        };

        lucide.createIcons();
    </script>
</body>
</html>
