<!DOCTYPE html>
<html lang="ku" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Madphone - Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@300;400;600;700&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* ── Mobile viewport fix for login overlay ── */
        html, body {
            height: 100%;
        }
        body {
            font-family: 'Noto Sans Arabic', sans-serif;
            background-color: #f9fafb;
        }
        body.login-active {
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
        }
        #loginOverlay {
            /* Extra insurance for iOS Safari */
            -webkit-transform: translateZ(0);
            transform: translateZ(0);
        }

        .modal {
            display: none;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
        }

        .modal.active {
            display: flex;
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-thumb {
            background: #8b5cf6;
            border-radius: 10px;
        }
    </style>
</head>

<body class="text-gray-900">

    <!-- ═══════════════════════════════════════════════════════════════════
         LOGIN SCREEN OVERLAY
         Shows before the dashboard. Hidden after successful Firebase login.
    ═══════════════════════════════════════════════════════════════════ -->
    <div id="loginOverlay" style="position:fixed;top:0;left:0;right:0;bottom:0;width:100vw;height:100vh;min-height:-webkit-fill-available;z-index:99999;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#4c1d95,#312e81,#111827);overflow-y:auto;-webkit-overflow-scrolling:touch;">
        <div style="background:white;border-radius:24px;width:calc(100% - 32px);max-width:440px;box-shadow:0 25px 60px rgba(0,0,0,0.4);padding:40px 32px;margin:auto;" class="space-y-6">
            <!-- Logo -->
            <div class="text-center space-y-2">
                <div class="w-16 h-16 bg-purple-100 rounded-2xl flex items-center justify-center mx-auto">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 text-purple-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                </div>
                <h1 class="text-2xl font-bold text-gray-900">Madphone Admin</h1>
                <p class="text-gray-400 text-sm">تکایە بچۆ ژوورەوە بۆ بەردەوامبوون</p>
            </div>

            <!-- Login Form -->
            <div id="loginForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-600 mb-1">ئیمەیڵ</label>
                    <input id="loginEmail" type="email" placeholder="admin@example.com"
                        class="w-full p-3 border-2 border-gray-100 rounded-xl focus:outline-none focus:border-purple-400 transition-colors text-left"
                        dir="ltr">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-600 mb-1">پاسوۆرد</label>
                    <div class="relative">
                        <input id="loginPassword" type="password" placeholder="••••••••"
                            class="w-full p-3 border-2 border-gray-100 rounded-xl focus:outline-none focus:border-purple-400 transition-colors text-left"
                            dir="ltr">
                        <button type="button" onclick="togglePasswordVisibility()"
                            class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600">
                            <svg id="eyeIcon" xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                        </button>
                    </div>
                </div>
                <div id="loginError" class="hidden bg-red-50 border border-red-200 text-red-600 text-sm px-4 py-3 rounded-xl"></div>
                <button onclick="handleLogin()"
                    class="w-full bg-purple-600 text-white py-3.5 rounded-xl font-bold hover:bg-purple-700 transition-colors shadow-lg shadow-purple-100 flex items-center justify-center gap-2">
                    <span id="loginBtnText">چوونەژوورەوە</span>
                    <svg id="loginSpinner" class="hidden w-5 h-5 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"/></svg>
                </button>
                <button onclick="showForgotForm()"
                    class="w-full text-purple-600 text-sm font-semibold hover:text-purple-800 transition-colors py-1">
                    پاسوۆردت بیرت چووە؟
                </button>
            </div>

            <!-- Forgot Password Form -->
            <div id="forgotForm" class="hidden space-y-4">
                <div class="text-center">
                    <p class="text-gray-500 text-sm">ئیمەیڵەکەت بنووسە، لینکی گەڕانەوەی پاسوۆرد دەنێرین بۆت</p>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-600 mb-1">ئیمەیڵ</label>
                    <input id="resetEmail" type="email" placeholder="admin@example.com"
                        class="w-full p-3 border-2 border-gray-100 rounded-xl focus:outline-none focus:border-purple-400 transition-colors text-left"
                        dir="ltr">
                </div>
                <div id="resetMsg" class="hidden text-sm px-4 py-3 rounded-xl"></div>
                <button onclick="handleForgotPassword()"
                    class="w-full bg-indigo-600 text-white py-3.5 rounded-xl font-bold hover:bg-indigo-700 transition-colors flex items-center justify-center gap-2">
                    <span id="resetBtnText">ناردنی لینکی گەڕانەوە</span>
                    <svg id="resetSpinner" class="hidden w-5 h-5 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"/></svg>
                </button>
                <button onclick="showLoginForm()"
                    class="w-full text-gray-400 text-sm font-semibold hover:text-gray-600 transition-colors py-1">
                    ← گەڕانەوە بۆ چوونەژوورەوە
                </button>
            </div>
        </div>
    </div>
    <!-- END LOGIN SCREEN -->

    <!-- Firebase Status Badge -->
    <div id="firebaseStatus"
        class="fixed bottom-6 left-6 z-50 bg-amber-400 text-white px-4 py-2 rounded-full text-sm font-bold shadow-lg flex items-center gap-2">
        <i data-lucide="loader" class="w-4 h-4 animate-spin"></i> چاوەڕوانی پەیوەندی...
    </div>

    <!-- Nav -->
    <nav class="bg-white shadow-lg sticky top-0 z-50 border-b-2 border-purple-100">
        <div class="max-w-7xl mx-auto px-3 sm:px-4 h-14 sm:h-16 flex justify-between items-center">
            <div class="flex items-center gap-1.5 sm:gap-2 min-w-0">
                <i data-lucide="shield" class="text-purple-600 w-6 h-6 sm:w-8 sm:h-8 flex-shrink-0"></i>
                <h1 class="text-base sm:text-2xl font-bold text-purple-900 truncate">Madphone Admin</h1>
            </div>
            <div class="flex items-center gap-1.5 sm:gap-3 flex-shrink-0">
                <span class="hidden sm:inline bg-purple-50 text-purple-600 px-4 py-1 rounded-full text-sm font-bold border border-purple-100">سەرپەرشتیار</span>
                <a href="https://dsledar.github.io/Madphone/store.html"
                    class="bg-indigo-600 text-white px-2.5 sm:px-4 py-2 rounded-xl text-sm font-bold hover:bg-indigo-700 transition-colors flex items-center gap-1.5">
                    <i data-lucide="store" class="w-4 h-4 flex-shrink-0"></i>
                    <span class="hidden sm:inline">فرۆشگا</span>
                </a>
                <button onclick="handleLogout()"
                    class="bg-red-50 text-red-600 border border-red-100 px-2.5 sm:px-4 py-2 rounded-xl text-sm font-bold hover:bg-red-100 transition-colors flex items-center gap-1.5">
                    <i data-lucide="log-out" class="w-4 h-4 flex-shrink-0"></i>
                    <span class="hidden sm:inline">چوونەدەرەوە</span>
                </button>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-3 sm:px-4 mt-4 sm:mt-8 space-y-6 sm:space-y-10 pb-20">

        <!-- Stats -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 sm:gap-4">
            <div class="bg-white p-4 sm:p-6 rounded-2xl shadow-sm border flex items-center gap-3">
                <div class="p-2.5 sm:p-3 rounded-xl bg-indigo-50 text-indigo-600 flex-shrink-0"><i data-lucide="package" class="w-5 h-5 sm:w-6 sm:h-6"></i></div>
                <div>
                    <p class="text-gray-400 text-xs sm:text-sm">بەرهەم</p>
                    <h4 id="statProducts" class="text-xl sm:text-2xl font-bold">0</h4>
                </div>
            </div>
            <div class="bg-white p-4 sm:p-6 rounded-2xl shadow-sm border flex items-center gap-3">
                <div class="p-2.5 sm:p-3 rounded-xl bg-blue-50 text-blue-600 flex-shrink-0"><i data-lucide="shopping-cart" class="w-5 h-5 sm:w-6 sm:h-6"></i></div>
                <div>
                    <p class="text-gray-400 text-xs sm:text-sm">داواکاری</p>
                    <h4 id="statOrders" class="text-xl sm:text-2xl font-bold">0</h4>
                </div>
            </div>
            <div class="bg-white p-4 sm:p-6 rounded-2xl shadow-sm border flex items-center gap-3">
                <div class="p-2.5 sm:p-3 rounded-xl bg-amber-50 text-amber-600 flex-shrink-0"><i data-lucide="clock" class="w-5 h-5 sm:w-6 sm:h-6"></i></div>
                <div>
                    <p class="text-gray-400 text-xs sm:text-sm">چاوەڕوان</p>
                    <h4 id="statPending" class="text-xl sm:text-2xl font-bold">0</h4>
                </div>
            </div>
            <div class="bg-white p-4 sm:p-6 rounded-2xl shadow-sm border flex items-center gap-3">
                <div class="p-2.5 sm:p-3 rounded-xl bg-emerald-50 text-emerald-600 flex-shrink-0"><i data-lucide="dollar-sign" class="w-5 h-5 sm:w-6 sm:h-6"></i></div>
                <div>
                    <p class="text-gray-400 text-xs sm:text-sm">داهات</p>
                    <h4 id="statRevenue" class="text-xl sm:text-2xl font-bold">$0</h4>
                </div>
            </div>
        </div>

        <!-- Products Table -->
        <section class="bg-white rounded-2xl shadow-sm border overflow-hidden">
            <div class="p-4 sm:p-6 border-b flex flex-wrap justify-between items-center gap-3 bg-gray-50/50">
                <h3 class="text-lg sm:text-xl font-bold flex items-center gap-2">
                    <i data-lucide="package" class="text-purple-600 w-5 h-5"></i> لیستەی بەرهەمەکان
                </h3>
                <div class="flex flex-wrap gap-2 w-full sm:w-auto">
                    <button onclick="openResetModal()"
                        class="flex-1 sm:flex-none bg-amber-500 text-white px-3 sm:px-4 py-2 rounded-xl text-sm font-bold hover:bg-amber-600 transition-colors flex items-center justify-center gap-2 shadow-md shadow-amber-100">
                        <i data-lucide="rotate-ccw" class="w-4 h-4 flex-shrink-0"></i>
                        <span class="hidden sm:inline">ڕیسێتکردنی فرۆشتن و قازانج</span>
                        <span class="sm:hidden">ڕیسێت</span>
                    </button>
                    <button onclick="openProductModal()"
                        class="flex-1 sm:flex-none bg-purple-600 text-white px-3 sm:px-5 py-2 rounded-xl text-sm font-bold hover:bg-purple-700 transition-colors flex items-center justify-center gap-2 shadow-lg shadow-purple-100">
                        <i data-lucide="plus" class="w-4 h-4 flex-shrink-0"></i> زیادکردنی بەرهەم
                    </button>
                </div>
            </div>
            <div class="overflow-x-auto -webkit-overflow-scrolling-touch">
                <table class="w-full text-right" style="min-width:500px">
                    <thead class="bg-gray-50 text-gray-500 text-xs sm:text-sm font-bold border-b">
                        <tr>
                            <th class="p-3 sm:p-4">بەرهەم</th>
                            <th class="p-3 sm:p-4">نرخ</th>
                            <th class="p-3 sm:p-4">کۆگا</th>
                            <th class="p-3 sm:p-4">فرۆشراو</th>
                            <th class="p-3 sm:p-4">چاوەڕوان</th>
                            <th class="p-3 sm:p-4">کردار</th>
                        </tr>
                    </thead>
                    <tbody id="productTableBody" class="divide-y"></tbody>
                </table>
            </div>
        </section>

        <!-- Orders Section -->
        <section class="space-y-4">
            <div class="flex flex-wrap justify-between items-center gap-3">
                <h3 class="text-lg sm:text-xl font-bold flex items-center gap-2">
                    <i data-lucide="shopping-cart" class="text-blue-600 w-5 h-5"></i> داواکارییەکان
                </h3>
                <button onclick="deleteAllOrders()"
                    class="bg-red-500 text-white px-3 sm:px-4 py-2 rounded-xl text-sm font-bold hover:bg-red-600 transition-colors flex items-center gap-2 shadow-md shadow-red-100">
                    <i data-lucide="trash-2" class="w-4 h-4 flex-shrink-0"></i> سڕینەوەی هەموو داواکارییەکان
                </button>
            </div>
            <div id="ordersGrid" class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6"></div>
        </section>

    </main>

    <!-- Product Modal -->
    <div id="productModal" class="modal fixed inset-0 z-50 items-center justify-center p-4">
        <div class="bg-white rounded-3xl w-full max-w-lg shadow-2xl p-8 space-y-4">
            <h3 id="modalTitle" class="text-2xl font-bold">زیادکردنی بەرهەم</h3>
            <input id="prodName" class="w-full p-3 border rounded-xl focus:outline-none focus:border-purple-400"
                placeholder="ناوی بەرهەم">
            <div class="grid grid-cols-2 gap-4">
                <input id="prodPrice" type="number"
                    class="w-full p-3 border rounded-xl focus:outline-none focus:border-purple-400" placeholder="نرخ $">
                <input id="prodQty" type="number"
                    class="w-full p-3 border rounded-xl focus:outline-none focus:border-purple-400"
                    placeholder="بڕی کۆگا">
            </div>
            <textarea id="prodDesc" class="w-full p-3 border rounded-xl h-24 focus:outline-none focus:border-purple-400"
                placeholder="وەسفی کورت"></textarea>
            <!-- Image: upload from gallery OR paste a URL -->
            <div class="space-y-2">
                <!-- File picker -->
                <label class="flex items-center justify-center gap-2 w-full p-3 border-2 border-dashed border-purple-300 rounded-xl cursor-pointer hover:bg-purple-50 transition-colors text-purple-600 font-semibold text-sm"
                    id="imgPickerLabel">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
                    <span id="imgPickerText">وێنە هەڵبژێرە لە گەلەری</span>
                    <input id="prodImgFile" type="file" accept="image/*" class="hidden" onchange="handleImageFile(this)">
                </label>
                <!-- Preview -->
                <div id="imgPreviewWrap" class="hidden">
                    <img id="imgPreview" src="" class="w-full h-32 object-cover rounded-xl border" alt="preview">
                </div>
                <!-- URL fallback -->
                <div class="flex items-center gap-2">
                    <div class="flex-1 h-px bg-gray-200"></div>
                    <span class="text-xs text-gray-400">یان لینک بنووسە</span>
                    <div class="flex-1 h-px bg-gray-200"></div>
                </div>
                <input id="prodImg" class="w-full p-3 border rounded-xl focus:outline-none focus:border-purple-400 text-sm" dir="ltr"
                    placeholder="https://..." oninput="handleImgUrlInput(this)">
            </div>
            <button onclick="saveProduct()"
                class="w-full bg-purple-600 text-white py-4 rounded-2xl font-bold shadow-xl hover:bg-purple-700 transition-colors">پاشەکەوتکردن</button>
            <button onclick="closeProductModal()"
                class="w-full text-gray-400 font-semibold hover:text-gray-600 transition-colors">داخستن</button>
        </div>
    </div>

    <!-- Reset Confirm Modal -->
    <div id="resetModal" class="modal fixed inset-0 z-50 items-center justify-center p-4">
        <div class="bg-white rounded-3xl w-full max-w-sm shadow-2xl p-8 space-y-6 text-center">
            <div class="w-16 h-16 bg-amber-100 rounded-full flex items-center justify-center mx-auto text-amber-500">
                <i data-lucide="alert-triangle" class="w-8 h-8"></i>
            </div>
            <h3 class="text-xl font-bold">ڕیسێتکردن دڵنیاکەرەوە؟</h3>
            <p class="text-gray-500 text-sm">ئەمە ژمارەی فرۆشراو و داهاتی کۆتای سفر دەکاتەوە و داواکارییە تەواوبووەکان
                دەسڕێتەوە.</p>
            <div class="flex gap-3">
                <button onclick="confirmReset()"
                    class="flex-1 bg-amber-500 text-white py-3 rounded-xl font-bold hover:bg-amber-600 transition-colors">بەڵێ،
                    ڕیسێتبکە</button>
                <button onclick="toggleModal('resetModal', false)"
                    class="flex-1 bg-gray-100 text-gray-600 py-3 rounded-xl font-bold hover:bg-gray-200 transition-colors">نەخێر</button>
            </div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════════
         FIREBASE AUTHENTICATION — LOGIN / LOGOUT / FORGOT PASSWORD
    ═══════════════════════════════════════════════════════════════════ -->
    <script type="module">
        import { initializeApp, getApps } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import {
            getAuth,
            signInWithEmailAndPassword,
            sendPasswordResetEmail,
            onAuthStateChanged,
            signOut
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAx6nZbWvHGkk0zRQdIVHbG2hmK29pWzAY",
            authDomain: "madphone-1706c.firebaseapp.com",
            databaseURL: "https://madphone-1706c-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "madphone-1706c",
            storageBucket: "madphone-1706c.firebasestorage.app",
            messagingSenderId: "777789640049",
            appId: "1:777789640049:web:71255405df7ffc32257ad0"
        };

        // Re-use existing app if already initialized by the dashboard script
        const authApp = getApps().find(a => a.name === '[DEFAULT]') || initializeApp(firebaseConfig);
        const auth = getAuth(authApp);

        const loginOverlay = document.getElementById('loginOverlay');

        // ── Auth state watcher: hide/show overlay ──────────────────────────
        onAuthStateChanged(auth, (user) => {
            if (user) {
                loginOverlay.style.display = 'none';
                document.body.classList.remove('login-active');
            } else {
                loginOverlay.style.display = 'flex';
                document.body.classList.add('login-active');
                // Force overlay to cover full viewport on mobile
                loginOverlay.style.height = window.innerHeight + 'px';
            }
        });

        // Re-measure on resize/orientation change (mobile keyboard, rotation)
        window.addEventListener('resize', () => {
            if (loginOverlay.style.display !== 'none') {
                loginOverlay.style.height = window.innerHeight + 'px';
            }
        });

        // ── Helpers ────────────────────────────────────────────────────────
        function setLoginLoading(on) {
            document.getElementById('loginSpinner').classList.toggle('hidden', !on);
            document.getElementById('loginBtnText').textContent = on ? 'چاوەڕوانبە...' : 'چوونەژوورەوە';
        }
        function setResetLoading(on) {
            document.getElementById('resetSpinner').classList.toggle('hidden', !on);
            document.getElementById('resetBtnText').textContent = on ? 'چاوەڕوانبە...' : 'ناردنی لینکی گەڕانەوە';
        }
        function showError(msg) {
            const el = document.getElementById('loginError');
            el.textContent = msg;
            el.classList.remove('hidden');
        }
        function hideError() {
            document.getElementById('loginError').classList.add('hidden');
        }
        function showResetMsg(msg, isSuccess) {
            const el = document.getElementById('resetMsg');
            el.textContent = msg;
            el.className = isSuccess
                ? 'text-sm px-4 py-3 rounded-xl bg-green-50 border border-green-200 text-green-700'
                : 'text-sm px-4 py-3 rounded-xl bg-red-50 border border-red-200 text-red-600';
            el.classList.remove('hidden');
        }

        // ── Map Firebase error codes to Kurdish messages ───────────────────
        function authErrorMsg(code) {
            const map = {
                'auth/user-not-found': 'ئەم ئیمەیڵە تۆمارنەکراوە.',
                'auth/wrong-password': 'پاسوۆردەکە هەڵەیە.',
                'auth/invalid-email': 'ئیمەیڵ شێوازی دروست نییە.',
                'auth/too-many-requests': 'زۆر هەوڵی نادروست. کەمێک چاوەڕوانبە.',
                'auth/invalid-credential': 'ئیمەیڵ یان پاسوۆرد هەڵەیە.',
                'auth/network-request-failed': 'هەڵەی تۆڕ. ئینتەرنێتەکەت بپشکنە.',
            };
            return map[code] || 'هەڵەیەک ڕوویدا. دووبارە هەوڵبدەرەوە.';
        }

        // ── Login ──────────────────────────────────────────────────────────
        window.handleLogin = async () => {
            hideError();
            const email = document.getElementById('loginEmail').value.trim();
            const pass  = document.getElementById('loginPassword').value;
            if (!email || !pass) { showError('تکایە ئیمەیڵ و پاسوۆرد بنووسە.'); return; }
            setLoginLoading(true);
            try {
                await signInWithEmailAndPassword(auth, email, pass);
                // onAuthStateChanged will hide the overlay automatically
            } catch (e) {
                showError(authErrorMsg(e.code));
            } finally {
                setLoginLoading(false);
            }
        };

        // ── Forgot password ────────────────────────────────────────────────
        window.handleForgotPassword = async () => {
            document.getElementById('resetMsg').classList.add('hidden');
            const email = document.getElementById('resetEmail').value.trim();
            if (!email) { showResetMsg('تکایە ئیمەیڵەکەت بنووسە.', false); return; }
            setResetLoading(true);
            try {
                await sendPasswordResetEmail(auth, email);
                showResetMsg('✅ ئیمەیڵی گەڕانەوەی پاسوۆرد نێردرا. تکایە سندوقی ئیمەیڵەکەت بپشکنە.', true);
            } catch (e) {
                showResetMsg(authErrorMsg(e.code), false);
            } finally {
                setResetLoading(false);
            }
        };

        // ── Logout ─────────────────────────────────────────────────────────
        window.handleLogout = async () => {
            if (!confirm('دڵنیای لە چوونەدەرەوە؟')) return;
            await signOut(auth);
        };

        // ── Form switchers ─────────────────────────────────────────────────
        window.showForgotForm = () => {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('forgotForm').classList.remove('hidden');
            document.getElementById('resetMsg').classList.add('hidden');
        };
        window.showLoginForm = () => {
            document.getElementById('forgotForm').classList.add('hidden');
            document.getElementById('loginForm').classList.remove('hidden');
            hideError();
        };

        // ── Password visibility toggle ─────────────────────────────────────
        window.togglePasswordVisibility = () => {
            const input = document.getElementById('loginPassword');
            input.type = input.type === 'password' ? 'text' : 'password';
        };

        // ── Allow Enter key to submit ──────────────────────────────────────
        document.getElementById('loginPassword').addEventListener('keydown', e => {
            if (e.key === 'Enter') window.handleLogin();
        });
        document.getElementById('loginEmail').addEventListener('keydown', e => {
            if (e.key === 'Enter') document.getElementById('loginPassword').focus();
        });
        document.getElementById('resetEmail').addEventListener('keydown', e => {
            if (e.key === 'Enter') window.handleForgotPassword();
        });
    </script>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, onValue } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';


        const firebaseConfig = {
            apiKey: "AIzaSyAx6nZbWvHGkk0zRQdIVHbG2hmK29pWzAY",
            authDomain: "madphone-1706c.firebaseapp.com",
            databaseURL: "https://madphone-1706c-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "madphone-1706c",
            storageBucket: "madphone-1706c.firebasestorage.app",
            messagingSenderId: "777789640049",
            appId: "1:777789640049:web:71255405df7ffc32257ad0"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const dbRef = ref(database, '/');

        // ─── Image upload helpers (base64 via Canvas — no Firebase Storage needed) ───
        window.handleImageFile = (input) => {
            const file = input.files[0];
            if (!file) return;
            const label = document.getElementById('imgPickerText');
            const preview = document.getElementById('imgPreview');
            const previewWrap = document.getElementById('imgPreviewWrap');
            label.textContent = 'چاوەڕوانبە...';
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const MAX = 600;
                    let w = img.width, h = img.height;
                    if (w > MAX) { h = Math.round(h * MAX / w); w = MAX; }
                    const canvas = document.createElement('canvas');
                    canvas.width = w; canvas.height = h;
                    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                    const base64 = canvas.toDataURL('image/jpeg', 0.75);
                    document.getElementById('prodImg').value = base64;
                    preview.src = base64;
                    previewWrap.classList.remove('hidden');
                    label.textContent = '✅ وێنەکە ئامادەیە';
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        };

        window.handleImgUrlInput = (input) => {
            const url = input.value.trim();
            const preview = document.getElementById('imgPreview');
            const previewWrap = document.getElementById('imgPreviewWrap');
            if (url) {
                preview.src = url;
                previewWrap.classList.remove('hidden');
                document.getElementById('imgPickerText').textContent = 'وێنە هەڵبژێرە لە گەلەری';
                document.getElementById('prodImgFile').value = '';
            } else {
                previewWrap.classList.add('hidden');
            }
        };

        let storeData = { products: [], orders: [], nextOrderId: 1, nextProductId: 1 };
        let editingId = null;

        // ─── Modal helpers ────────────────────────────────────────────────
        window.toggleModal = (id, show) => {
            document.getElementById(id).classList.toggle('active', show);
        };
        window.openProductModal = () => {
            editingId = null;
            document.getElementById('modalTitle').textContent = 'زیادکردنی بەرهەم';
            ['prodName', 'prodDesc', 'prodImg'].forEach(id => document.getElementById(id).value = '');
            ['prodPrice', 'prodQty'].forEach(id => document.getElementById(id).value = '');
            document.getElementById('prodImgFile').value = '';
            document.getElementById('imgPickerText').textContent = 'وێنە هەڵبژێرە لە گەلەری';
            document.getElementById('imgPreviewWrap').classList.add('hidden');
            toggleModal('productModal', true);
        };
        window.closeProductModal = () => toggleModal('productModal', false);
        window.openResetModal = () => toggleModal('resetModal', true);

        // ─── Firebase realtime listener ───────────────────────────────────
        onValue(dbRef, (snapshot) => {
            const statusEl = document.getElementById('firebaseStatus');
            if (snapshot.exists()) {
                const data = snapshot.val();
                storeData = {
                    products: data.products
                        ? (Array.isArray(data.products) ? data.products : Object.values(data.products))
                        : [],
                    orders: data.orders
                        ? (Array.isArray(data.orders) ? data.orders : Object.values(data.orders))
                        : [],
                    nextOrderId: data.nextOrderId || 1,
                    nextProductId: data.nextProductId || 1
                };
                statusEl.innerHTML = '<i data-lucide="wifi" class="w-4 h-4"></i> پەیوەستە بە Firebase';
                statusEl.className = 'fixed bottom-6 left-6 z-50 bg-emerald-500 text-white px-4 py-2 rounded-full text-sm font-bold shadow-lg flex items-center gap-2';
                updateDashboard();
                lucide.createIcons();
            } else {
                statusEl.innerHTML = '<i data-lucide="wifi-off" class="w-4 h-4"></i> هیچ داتایەک نییە';
                statusEl.className = 'fixed bottom-6 left-6 z-50 bg-red-500 text-white px-4 py-2 rounded-full text-sm font-bold shadow-lg flex items-center gap-2';
                lucide.createIcons();
            }
        }, () => {
            const statusEl = document.getElementById('firebaseStatus');
            statusEl.innerHTML = '<i data-lucide="alert-circle" class="w-4 h-4"></i> هەڵەی پەیوەندی';
            statusEl.className = 'fixed bottom-6 left-6 z-50 bg-red-500 text-white px-4 py-2 rounded-full text-sm font-bold shadow-lg flex items-center gap-2';
            lucide.createIcons();
        });

        // ─── Dashboard update ──────────────────────────────────────────────
        function updateDashboard() {
            document.getElementById('statProducts').textContent = storeData.products.length;
            document.getElementById('statOrders').textContent = storeData.orders.length;
            document.getElementById('statPending').textContent = storeData.orders.filter(o => o.status === 'pending').length;
            const rev = storeData.orders.filter(o => o.status === 'completed').reduce((s, o) => s + o.total, 0);
            document.getElementById('statRevenue').textContent = `$${rev.toFixed(2)}`;
            renderProducts();
            renderOrders();
        }

        // ─── Render products table ─────────────────────────────────────────
        function renderProducts() {
            const tbody = document.getElementById('productTableBody');
            if (storeData.products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="p-8 text-center text-gray-400">هیچ بەرهەمێک نەدۆزرایەوە</td></tr>';
                return;
            }
            tbody.innerHTML = storeData.products.map(p => {
                const available = (p.quantity || 0) - (p.pending || 0);
                const stockColor = available === 0 ? 'text-red-500' : (available < 5 ? 'text-amber-500' : 'text-gray-700');
                return `
                <tr class="hover:bg-gray-50 transition-colors">
                    <td class="p-3 sm:p-4">
                        <div class="flex items-center gap-2 sm:gap-3">
                            ${p.image
                        ? `<img src="${p.image}" class="w-8 h-8 sm:w-10 sm:h-10 rounded-lg object-cover border flex-shrink-0" onerror="this.style.display='none'">`
                        : `<div class="w-8 h-8 sm:w-10 sm:h-10 rounded-lg bg-indigo-50 flex items-center justify-center text-indigo-300 flex-shrink-0"><i data-lucide="smartphone" class="w-4 h-4"></i></div>`
                    }
                            <span class="font-bold text-sm sm:text-base">${p.name}</span>
                        </div>
                    </td>
                    <td class="p-3 sm:p-4 text-purple-600 font-bold text-sm sm:text-base whitespace-nowrap">$${parseFloat(p.price).toFixed(2)}</td>
                    <td class="p-3 sm:p-4 font-semibold text-sm sm:text-base ${stockColor}">${available}</td>
                    <td class="p-3 sm:p-4 text-green-600 font-bold text-sm sm:text-base">${p.sold || 0}</td>
                    <td class="p-3 sm:p-4 text-amber-600 font-bold text-sm sm:text-base">${p.pending || 0}</td>
                    <td class="p-3 sm:p-4">
                        <div class="flex gap-1 sm:gap-2">
                            <button onclick="editProduct(${p.id})" class="text-blue-500 p-1.5 sm:p-2 hover:bg-blue-50 rounded-lg transition-colors"><i data-lucide="edit" class="w-4 h-4"></i></button>
                            <button onclick="deleteProduct(${p.id})" class="text-red-500 p-1.5 sm:p-2 hover:bg-red-50 rounded-lg transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    </td>
                </tr>`;
            }).join('');
            lucide.createIcons();
        }

        // ─── Render orders grid ────────────────────────────────────────────
        // Firebase stores arrays as objects with numeric keys — always normalize
        function toArray(val) {
            if (!val) return [];
            if (Array.isArray(val)) return val;
            return Object.values(val);
        }

        function renderOrders() {
            const grid = document.getElementById('ordersGrid');
            if (storeData.orders.length === 0) {
                grid.innerHTML = '<div class="col-span-2 text-center py-12 text-gray-400 bg-white rounded-2xl border"><i data-lucide="inbox" class="w-12 h-12 mx-auto mb-3 opacity-30"></i><p>هیچ داواکارییەک نییە</p></div>';
                lucide.createIcons();
                return;
            }
            const statusStyles = {
                pending: { badge: 'bg-amber-100 text-amber-700', card: 'border-amber-200' },
                completed: { badge: 'bg-green-100 text-green-700', card: 'border-green-200' },
                cancelled: { badge: 'bg-red-100 text-red-700', card: 'border-gray-100' }
            };
            const statusLabels = { pending: 'چاوەڕوان', completed: 'تەواوبوو', cancelled: 'هەڵوەشاوە' };

            grid.innerHTML = storeData.orders.slice().reverse().map(order => {
                const s = statusStyles[order.status] || statusStyles.pending;
                // CRITICAL FIX: Firebase stores nested arrays as objects — normalize here
                const items = toArray(order.items);
                return `
                <div class="bg-white p-6 rounded-2xl border-2 ${s.card} shadow-sm space-y-4">
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-bold text-lg">#${order.id} - ${order.customerName || ''}</h4>
                            <p class="text-sm text-gray-500 mt-1">${order.phone || ''} | ${order.location || ''}</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="px-3 py-1 rounded-full text-xs font-bold ${s.badge}">${statusLabels[order.status] || order.status}</span>
                            <button onclick="deleteSingleOrder(${order.id})" class="text-red-400 hover:text-red-600 hover:bg-red-50 p-1.5 rounded-lg transition-colors" title="سڕینەوەی داواکاری">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-xl space-y-2 text-sm border">
                        ${items.map(i => `
                            <div class="flex justify-between">
                                <span>${i.name || '?'} × ${i.quantity || 0}</span>
                                <span class="font-bold">$${((i.price || 0) * (i.quantity || 0)).toFixed(2)}</span>
                            </div>
                        `).join('')}
                        <div class="pt-2 border-t flex justify-between font-bold text-indigo-600">
                            <span>کۆی گشتی</span><span>$${parseFloat(order.total || 0).toFixed(2)}</span>
                        </div>
                    </div>
                    ${order.status === 'pending' ? `
                        <div class="flex gap-3">
                            <button onclick="updateOrderStatus(${order.id}, 'completed')" class="flex-1 bg-green-500 text-white py-2 rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-green-600 transition-colors">
                                <i data-lucide="check" class="w-4 h-4"></i> تەواوکردن
                            </button>
                            <button onclick="updateOrderStatus(${order.id}, 'cancelled')" class="flex-1 bg-red-500 text-white py-2 rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-red-600 transition-colors">
                                <i data-lucide="x" class="w-4 h-4"></i> هەڵوەشاندن
                            </button>
                        </div>
                    ` : ''}
                </div>`;
            }).join('');
            lucide.createIcons();
        }

        // ─── Save / Edit product ───────────────────────────────────────────
        window.saveProduct = async () => {
            const name = document.getElementById('prodName').value.trim();
            const price = parseFloat(document.getElementById('prodPrice').value);
            const qty = parseInt(document.getElementById('prodQty').value) || 0;
            const desc = document.getElementById('prodDesc').value.trim();
            const img = document.getElementById('prodImg').value.trim();
            if (!name || isNaN(price)) return alert('ناوی بەرهەم و نرخ بنووسە');

            let updatedProducts;
            let nextPid = storeData.nextProductId;
            if (editingId !== null) {
                updatedProducts = storeData.products.map(p =>
                    p.id === editingId ? { ...p, name, price, quantity: qty, description: desc, image: img } : p
                );
            } else {
                updatedProducts = [...storeData.products, { id: nextPid, name, price, quantity: qty, sold: 0, pending: 0, description: desc, image: img }];
                nextPid++;
            }
            await set(dbRef, { ...storeData, products: updatedProducts, nextProductId: nextPid });
            closeProductModal();
        };

        window.editProduct = (id) => {
            const p = storeData.products.find(item => item.id === id);
            if (!p) return;
            editingId = id;
            document.getElementById('modalTitle').textContent = 'دەستکاریکردنی بەرهەم';
            document.getElementById('prodName').value = p.name;
            document.getElementById('prodPrice').value = p.price;
            document.getElementById('prodQty').value = p.quantity;
            document.getElementById('prodDesc').value = p.description || '';
            document.getElementById('prodImg').value = p.image || '';
            document.getElementById('prodImgFile').value = '';
            document.getElementById('imgPickerText').textContent = 'وێنە هەڵبژێرە لە گەلەری';
            const previewWrap = document.getElementById('imgPreviewWrap');
            if (p.image) {
                document.getElementById('imgPreview').src = p.image;
                previewWrap.classList.remove('hidden');
            } else {
                previewWrap.classList.add('hidden');
            }
            toggleModal('productModal', true);
        };

        window.deleteProduct = async (id) => {
            if (!confirm('دڵنیای لە سڕینەوەی ئەم بەرهەمە؟')) return;
            await set(dbRef, { ...storeData, products: storeData.products.filter(p => p.id !== id) });
        };

        // ─── Order status update ───────────────────────────────────────────
        window.updateOrderStatus = async (oid, status) => {
            const order = storeData.orders.find(o => o.id === oid);
            if (!order) return;
            const updatedOrders = storeData.orders.map(o => o.id === oid ? { ...o, status } : o);
            const orderItems = toArray(order.items);
            const updatedProducts = storeData.products.map(p => {
                const item = orderItems.find(i => i.productId === p.id);
                if (item) {
                    if (status === 'completed') return { ...p, pending: (p.pending || 0) - item.quantity, sold: (p.sold || 0) + item.quantity };
                    if (status === 'cancelled') return { ...p, pending: (p.pending || 0) - item.quantity, quantity: p.quantity + item.quantity };
                }
                return p;
            });
            await set(dbRef, { ...storeData, orders: updatedOrders, products: updatedProducts });
        };

        // ─── Delete single order ───────────────────────────────────────────
        window.deleteSingleOrder = async (oid) => {
            if (!confirm('دڵنیای لە سڕینەوەی ئەم داواکارییە؟')) return;
            const order = storeData.orders.find(o => o.id === oid);
            if (!order) return;
            let updatedProducts = storeData.products;
            if (order.status === 'pending') {
                const orderItems = toArray(order.items);
                updatedProducts = storeData.products.map(p => {
                    const item = orderItems.find(i => i.productId === p.id);
                    if (item) return { ...p, pending: Math.max(0, (p.pending || 0) - item.quantity), quantity: p.quantity + item.quantity };
                    return p;
                });
            }
            await set(dbRef, { ...storeData, orders: storeData.orders.filter(o => o.id !== oid), products: updatedProducts });
        };

        // ─── Delete all orders ─────────────────────────────────────────────
        window.deleteAllOrders = async () => {
            if (storeData.orders.length === 0) return alert('هیچ داواکارییەک نییە بۆ سڕینەوە');
            if (!confirm('دڵنیای لە سڕینەوەی هەموو داواکارییەکان؟ ئەم کردارە گەرانەوەی نییە.')) return;
            let updatedProducts = storeData.products.map(p => ({ ...p }));
            storeData.orders.filter(o => o.status === 'pending').forEach(order => {
                toArray(order.items).forEach(item => {
                    const p = updatedProducts.find(pr => pr.id === item.productId);
                    if (p) { p.pending = Math.max(0, (p.pending || 0) - item.quantity); p.quantity += item.quantity; }
                });
            });
            await set(dbRef, { ...storeData, orders: [], nextOrderId: 1, products: updatedProducts });
        };

        // ─── Reset sales stats ─────────────────────────────────────────────
        window.confirmReset = async () => {
            const updatedProducts = storeData.products.map(p => ({ ...p, sold: 0, pending: 0 }));
            const remainingOrders = storeData.orders.filter(o => o.status === 'pending');
            await set(dbRef, { ...storeData, products: updatedProducts, orders: remainingOrders });
            toggleModal('resetModal', false);
        };

        lucide.createIcons();
    </script>

</body>

</html>
